---
tags: []
title: Practical ansible
description: Let's see how we can write some common security playbooks for our
  ubuntu servers
date: 31th Aug 2025
image: /blog-images/cows.webp
draft: true
---

For getting taste of Ansible, Here i try to write some ansible playbooks for common security tasks. Here are the things that i think achievable with ansible:

1. Copy our ssh public key to all the remote servers, so we can connect to all servers without using password login
2. security updates
3. disabling password login
4. Firewall configuration
5. Changing the ssh port from 22 to something else. humans are smart enough to find that, we're doing this only for getting rid of some robots that are wandering the internet for finding insecure servers.(I know, some robots are also not that dumb but anyway)

Let's Go!

## Base templete

Our playbook can be a single file like this:

```yaml
- name: General Linux security hardening
  hosts: all
  become: true
  gather_facts: true
  remote_user: userblahblah
  tasks:
  - name: Ensure apache is at the latest version
    ansible.builtin.yum:
      name: httpd
      state: latest

  - name: Write the apache config file
    ansible.builtin.template:
      src: /srv/httpd.j2
      dest: /etc/httpd.conf

  - name: Ensure postgresql is at the latest version
    ansible.builtin.yum:
      name: postgresql
      state: latest

  - name: Ensure that postgresql is started
    ansible.builtin.service:
      name: postgresql
      state: started
```

But, without structuring your **ansible tasks** into seperate files, you will end up with long playbooks which is hard to maintain.

So you will be better off using `import_tasks` in tasks section:

```yaml
- name: General Linux security hardening
  hosts: all
  become: true
  gather_facts: true
  remote_user: userblahblah
  tasks:
    -  import_tasks: tasks/authorized_keys.yml
    -  import_tasks: tasks/disable_root_login.yml
  handlers:
    - import_tasks: handler/restart_ssh.yml
```

the address `tasks/**` is relative the playbook folder. `tasks` directory is where you define your tasks. (And they can be used in another playbooks as well)

So using this setup, we are going define our tasks in next sections:

## SSH public key

Before disabling password login and doing anything like this, you need to put your public key in the remote servers so you can login using ssh key authentication method. Otherwise you will be locked out and something bad happens

Because this is so common, it has it's own dedicated simple module named `ansible.posix.authorized_key`. Let's create the file `tasks/authorized_key`:

```yaml
---
- name: Copy local public key to destination server
  ansible.posix.authorized_key:
    user: tommy
    state: present
    key: "{{ lookup('file', lookup('env', 'HOME') + '/.ssh/id_ed25519.pub') }}"

```

we use the module `ansible.posix.authorized_key` to move our public key to remote server. fields are quite self explanatory. in the `key` field, you need to put your public key string. but instead you usually use the `lookup` plugin to use external text files as a value. in the `lookup` function call, we are trying to access our host's home directory using `$HOME` environment variable. and after that, we just concatenate that with `/.ssh/id_ed25519.pub` .

Define this task to your main playbook and run the playbook using the command `ansible-playbook` make sure it's doing it's job currectly. (Normally if the key is present in remote server, nothing should happen)

## Security update

Writing a task for automatically updating the security patches through `aptitude` would be really helpful and time saving.

Create the file `tasks/apt_security.yml` :

```yaml
- name: Update all packages to their latest version
  ansible.builtin.apt:
    name: "*"
    state: latest
    update_cache: true
    only_upgrade: true

```

We don't need to be too specific here. We just put the star as a package name and all packages will be upgraded to the latest patch version. The `update_cache` field will make sure the cache is updated before upgrade process.

::info
It's needless to say, we are using Ubuntu LTS and the package major versions are frozen in the entire support time span (5 years)
::

## Password login

## Firewall

## SSH port

## Wrap up

As you seen, Ansible has a really important place for automation In devops tool era. It's performant and ergonomic for writing common tasks. But as a downside, it's tedious to write and test properly. And also playbooks can become nasty for some tricky tasks like changing the ssh port and etc. Anyway, i'm happy with that.
